<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>受注兼発送依頼書</title>
    
    <!-- ライブラリ読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@700&display=swap');
      body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
      .font-serif { font-family: 'Noto Serif JP', serif; }
      
      .border-black { border-color: #000 !important; }
      .bg-label { background-color: #e5e7eb; }
      
      .text-base-plus { font-size: 1.1rem; }
      .text-sm-plus { font-size: 0.95rem; }
      .text-xs-plus { font-size: 0.85rem; }

      #debug-log {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
        background: #111; color: #0f0; font-family: monospace; font-size: 11px;
        overflow-y: auto; padding: 10px; z-index: 9999; opacity: 0.9;
        border-top: 2px solid #444; display: none; 
      }

      @media print {
        .print-hidden { display: none !important; }
        .print-full { width: 100% !important; max-width: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; border: none !important; }
        @page { size: A4; margin: 10mm; }
        body { background: white; -webkit-print-color-adjust: exact; }
        #debug-log { display: none !important; }
        input, select, textarea { border-bottom: none !important; }
        select { appearance: none; border: none; background: transparent; padding: 0; }
        #tab-bar { display: none !important; }
      }
      .writing-vertical-lr { writing-mode: vertical-lr; }
      
      .fade-out { animation: fadeOut 2s forwards; }
      @keyframes fadeOut {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; }
      }
      
      .tab-active {
        background-color: white;
        border-bottom-color: white;
        color: #2563eb;
      }
      .tab-inactive {
        background-color: #f3f4f6;
        border-bottom-color: #d1d5db;
        color: #6b7280;
      }
      .tab-inactive:hover {
        background-color: #e5e7eb;
      }
      /* 数値入力時の矢印を消す */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
      
      /* 読み取り専用時のスタイル */
      .input-locked {
        background-color: #f9fafb; /* gray-50 */
        color: #374151; /* gray-700 */
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div id="global-error"></div>
    <div id="root"></div>
    <div id="loading">
      <div class="fixed inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-[10000]">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div class="text-lg font-bold">システムを起動中...</div>
      </div>
    </div>
    <div id="debug-log"></div>

    <!-- GASパラメータ受け取り -->
    <div id="gas-data" style="display:none"
      data-order-no="<?= initialOrderNo ?>"
      data-summary-code="<?= initialSummaryCode ?>"
      data-user-role="<?= userRole ?>"
      data-user-title="<?= userTitle ?>"
      data-user-name="<?= userName ?>">
    </div>

    <datalist id="closing-dates"><option value="10日"/><option value="20日"/><option value="末日"/></datalist>
    <datalist id="payment-dates">
      <option value="当月末"/><option value="翌月10日"/><option value="翌月20日"/><option value="翌月末"/><option value="翌々月10日"/>
    </datalist>
    <datalist id="payment-details">
      <option value="現金"/><option value="振込"/><option value="手形"/><option value="手形　サイト90日"/><option value="手形　サイト120日"/>
      <option value="手形　サイト115日"/><option value="10万以上手形　サイト70日"/><option value="10万以上手形　サイト90日"/>
      <option value="10万以上手形　サイト97日"/><option value="10万以上手形　サイト120日"/><option value="50万以上半金半手サイト115日"/><option value="10万以上手形"/>
    </datalist>
    <datalist id="tech-requests">
      <option value="なし" />
      <option value="機械器具設置" /><option value="電気通信" /><option value="保守点検" /><option value="修繕" /><option value="その他" />
    </datalist>
    <datalist id="shipping-methods">
      <option value="※工場出荷無し" />
      <option value="ヤマト(PM)" />
      <option value="出荷庫準備" />
      <option value="レターパック" />
      <option value="航空便" />
      <option value="ヤマト(AM)" />
      <option value="佐川" />
    </datalist>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      // --- ユーティリティ関数 ---
      const generateId = () => crypto.randomUUID();
      const safeText = (val) => (val === undefined || val === null) ? '' : String(val);

      // --- パラメータ取得 ---
      const gasDataEl = document.getElementById('gas-data');
      const CONFIG = {
        initialOrderNo: gasDataEl?.dataset.orderNo || "232922",
        initialSummaryCode: gasDataEl?.dataset.summaryCode || "",
        userRole: gasDataEl?.dataset.userRole || "sales",
        userTitle: gasDataEl?.dataset.userTitle || "",
        userName: gasDataEl?.dataset.userName || "担当者"
      };

      // --- カスタム確認ダイアログ ---
      const CustomConfirm = ({ isOpen, message, onConfirm, onCancel }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[11000] print:hidden">
            <div className="bg-white rounded-lg shadow-2xl p-6 w-[400px] border border-gray-200">
              <div className="text-gray-800 text-base mb-6 font-medium leading-relaxed">{message}</div>
              <div className="flex justify-end space-x-3">
                <button onClick={onCancel} className="px-5 py-2 text-sm font-bold text-gray-600 hover:bg-gray-100 rounded-md transition-colors border border-gray-300">キャンセル</button>
                <button onClick={onConfirm} className="px-5 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors shadow-sm">OK</button>
              </div>
            </div>
          </div>
        );
      };

      // Icons
      const IconWrapper = ({ children, className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
      );
      const Printer = ({ className }) => <IconWrapper className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconWrapper>;
      const Save = ({ className }) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
      const FileSpreadsheet = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconWrapper>;
      const Plus = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
      const Trash2 = ({ className }) => <IconWrapper className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
      const Mail = ({ className }) => <IconWrapper className={className}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconWrapper>;
      const Lock = ({ className }) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
      const Loader = ({ className }) => <IconWrapper className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconWrapper>;
      const CloudCheck = ({ className }) => <IconWrapper className={className}><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="9 11 12 14 22 4"/></IconWrapper>;
      const Send = ({ className }) => <IconWrapper className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconWrapper>;

      // 数値入力コンポーネント (3桁区切り + マスキング)
      const NumberInput = ({ value, onChange, className, placeholder, readOnly, textAlign = 'right', isMasked = false }) => {
        const [isFocused, setIsFocused] = useState(false);
        const displayValue = useMemo(() => {
          if (isMasked) return '0';
          if (isFocused) return value; 
          if (value === '' || value === null || value === undefined) return '';
          const num = Number(value);
          if (isNaN(num)) return value;
          return num.toLocaleString(); 
        }, [value, isFocused, isMasked]);

        return (
          <input
            type="text"
            className={`${className} text-${textAlign} ${isMasked ? 'text-gray-300' : ''} ${readOnly ? 'input-locked' : ''}`}
            value={displayValue}
            onChange={(e) => {
               if (isMasked || readOnly) return;
               let v = e.target.value.replace(/,/g, '').replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
               if (v === '' || !isNaN(Number(v))) {
                 onChange(v);
               }
            }}
            onFocus={() => !readOnly && !isMasked && setIsFocused(true)}
            onBlur={() => setIsFocused(false)}
            placeholder={placeholder}
            readOnly={readOnly || isMasked}
          />
        );
      };

      // --- サブコンポーネント: 個別の受注シート ---
      const SingleOrderSheet = ({ data, isActive, onChange, onSave, onExportExcel, allTabs, tabId, saveStatus, currentUser }) => {
        const { mode, header, items, schedule, remarks, totals, paymentConditionType, paymentConditionDetail } = data;
        
        const [shippingRowCount, setShippingRowCount] = useState(3);
        const [confirmState, setConfirmState] = useState({ isOpen: false, message: '', onConfirm: null });

        const isTemporary = header.dataStatus === 'temporary';
        const isSubmitted = header.dataStatus === 'submitted';
        const isReplacement = header.dataStatus === 'replacement';
        const isLocked = isSubmitted && currentUser.role !== 'admin';

        const isAdmin = currentUser.role === 'admin';

        useEffect(() => {
          let maxIdx = 3;
          for(let i=1; i<=10; i++) {
             if(header[`shipDate${i}`] || header[`deliveryDate${i}`] || header[`deliveryTime${i}`] || header[`informationNo${i}`] || header[`shippingNo${i}`] || header[`deliveryMethod${i}`]) {
                maxIdx = Math.max(maxIdx, i);
             }
          }
          setShippingRowCount(maxIdx);
        }, [header]);

        const addShippingRow = () => { if (shippingRowCount < 10) setShippingRowCount(prev => prev + 1); };

        const updateData = (updates) => {
          if (isLocked) return; 
          onChange({ ...data, ...updates });
        };
        const updateHeader = (key, val) => updateData({ header: { ...header, [key]: val } });
        const updatePaymentType = (val) => updateData({ paymentConditionType: val });
        const updatePaymentDetail = (val) => updateData({ paymentConditionDetail: val });

        const updateItem = (idx, key, val) => {
          const row = items[idx];
          const isManual = String(row.id).includes('-');
          const canEditThisField = isManual ? !isSubmitted : !isLocked;
          if (!canEditThisField) return;

          const newItems = [...items];
          newItems[idx] = { ...newItems[idx], [key]: val };
          
          if (['quantity', 'unitPrice'].includes(key)) {
             newItems[idx].amount = (Number(newItems[idx].quantity) || 0) * (Number(newItems[idx].unitPrice) || 0);
          }
          if (['quantity', 'costPrice'].includes(key)) {
             newItems[idx].costAmount = (Number(newItems[idx].quantity) || 0) * (Number(newItems[idx].costPrice) || 0);
          }
          recalcTotals(newItems, schedule);
        };
        
        const deleteItem = (idx) => {
          if (isLocked) return;
          setConfirmState({
            isOpen: true,
            message: '明細を削除します。保存時に受注データ（スプレッドシート）からも消去されますが、よろしいですか？',
            onConfirm: () => {
              const newItems = [...items];
              newItems.splice(idx, 1);
              recalcTotals(newItems, schedule);
              setConfirmState({ ...confirmState, isOpen: false });
            },
            onCancel: () => setConfirmState({ ...confirmState, isOpen: false })
          });
        };

        const recalcTotals = (newItems, newSchedule) => {
          const subtotal = newItems.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                         + newSchedule.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
          const tax = Math.floor(subtotal * 0.1);
          onChange({ ...data, items: newItems, schedule: newSchedule, totals: { subtotal, tax, total: subtotal + tax } });
        }

        const updateSchedule = (idx, key, val) => {
          if (isLocked) return;
          const newSched = [...schedule];
          newSched[idx] = { ...newSched[idx], [key]: val };
          onChange({ ...data, schedule: newSched });
        };
        
        const updateRemark = (idx, key, val) => {
          if (isLocked) return;
          const newRemarks = [...remarks];
          newRemarks[idx] = { ...newRemarks[idx], [key]: val };
          onChange({ ...data, remarks: newRemarks });
        };

        const handleApproveAction = (stampType, stampLabel) => {
          setConfirmState({
            isOpen: true,
            // 英語(stampType)ではなく日本語(stampLabel)を使用
            message: `「${stampLabel}」として承認してよろしいですか？`,
            onConfirm: () => {
              if (typeof google !== 'undefined' && google.script) {
                google.script.run.withSuccessHandler((res) => {
                  if(res.success) {
                    const today = new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g,'/');
                    updateHeader(`approval${stampType}`, { status: '済', name: CONFIG.userName, date: today });
                  }
                }).approveOrder(header.orderNo, stampType, CONFIG.userName);
              }
              setConfirmState({ ...confirmState, isOpen: false });
            },
            onCancel: () => setConfirmState({ ...confirmState, isOpen: false })
          });
        }

        const canApprove = (type) => {
          const info = header[`approval${type}`];
          if(info && info.status === '済') return false;
          
          const title = CONFIG.userTitle;
          const status = header.dataStatus;

          if (type === 'Creator') {
            return status === '未' || status === '差し戻し' || status === 'official' || !status;
          }
          if (type === 'Check') {
            return (status === '未' || status === '差し戻し' || !status || status === 'official') && title === '営業担当者';
          }
          if (type === 'Manager') {
            return (status === '未' || status === '差し戻し' || !status || status === 'official') && title === '課長';
          }
          if (type === 'President') {
            return (status === '未' || status === '差し戻し' || !status || status === 'official') && title.includes('社長');
          }
          return false;
        }

        const Stamp = ({ title, info, stampKey, className }) => (
          <div className={`flex flex-col items-center justify-between border-l border-black w-14 h-20 bg-white ${className}`}>
            <div className="w-full text-center border-b border-black text-[10px] bg-label py-1 font-bold">{title}</div>
            <div className="flex-1 flex flex-col items-center justify-center w-full relative">
              {info && info.status === '済' ? (
                <div className="relative">
                  <div className="w-12 h-12 rounded-full border-2 border-red-600 flex flex-col items-center justify-center text-red-600 text-[9px] font-serif transform -rotate-12 select-none bg-white bg-opacity-90 leading-tight p-0.5 shadow-sm">
                    {/* 要件：承認印は名前のみを中央に表示 */}
                    <span className="text-[11px] font-bold leading-tight px-1 text-center whitespace-normal overflow-hidden max-h-full">
                      {info.name ? (info.name.split(' ').pop() || info.name) : '担当'}
                    </span>
                  </div>
                </div>
              ) : ( 
                <div className="flex flex-col items-center">
                  <span className="text-gray-200 text-xl font-bold">・</span>
                  {canApprove(stampKey) && (
                    <button onClick={() => handleApproveAction(stampKey, title)} className="mt-1 px-1 py-0.5 bg-red-50 text-red-600 border border-red-200 rounded text-[8px] hover:bg-red-100 print:hidden transition-colors">承認する</button>
                  )}
                </div>
              )}
            </div>
          </div>
        );

        const modeLabel = mode === 'rental' ? 'レンタル' : (mode === 'communication' ? '通信費' : '販売品');
        const borderColor = mode === 'rental' ? 'border-green-600' : (mode === 'communication' ? 'border-purple-600' : 'border-blue-600');
        const titleColor = mode === 'rental' ? 'text-green-700' : (mode === 'communication' ? 'text-purple-700' : 'text-blue-700');

        let gridColsClass = 'grid-cols-[30px_85px_1fr_60px_50px_50px_80px_80px_80px_1fr]';
        if (mode === 'sales') {
            gridColsClass = 'grid-cols-[30px_85px_1fr_50px_50px_80px_80px_80px]'; 
        }

        return (
          <div className={`w-full max-w-[1100px] print-full ${!isActive ? 'hidden' : ''}`}>
             {/* ダイアログ表示 */}
             <CustomConfirm 
                isOpen={confirmState.isOpen} 
                message={confirmState.message} 
                onConfirm={confirmState.onConfirm} 
                onCancel={confirmState.onCancel} 
             />

             <div className={`mb-6 bg-white p-4 rounded-lg shadow-md print-hidden flex justify-between items-center border-l-4 ${borderColor}`}>
                <div className="flex items-center space-x-4">
                  <div className="flex flex-col">
                    <span className={`font-bold ${titleColor} flex items-center text-lg`}>【{modeLabel}】</span>
                    <span className="text-xs text-gray-500">受注No: {header.orderNo}</span>
                  </div>
                  <div className="flex items-center space-x-2">
                     <select value={header.dataStatus} onChange={(e) => updateHeader('dataStatus', e.target.value)} className={`bg-gray-100 text-xs font-bold p-1 rounded border border-gray-300 outline-none cursor-pointer ${isLocked ? 'pointer-events-none text-gray-500' : ''}`} disabled={isLocked}>
                        <option value="official">通常(本番)</option>
                        <option value="temporary">【仮】(金額0)</option>
                        <option value="replacement">【差替】</option>
                        <option value="submitted">提出済(ロック)</option>
                     </select>
                  </div>
                </div>
                <div className="flex items-center space-x-3">
                  <div className="text-sm font-medium mr-2 flex items-center w-32 justify-end">
                    {saveStatus === 'saving' && <span className="text-blue-600 flex items-center animate-pulse"><Loader className="w-4 h-4 mr-1 animate-spin" /> 保存中...</span>}
                    {saveStatus === 'saved' && <span className="text-green-600 flex items-center fade-out"><CloudCheck className="w-4 h-4 mr-1" /> 保存完了</span>}
                  </div>
                  <button onClick={() => onExportExcel()} className="flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium text-sm shadow"><FileSpreadsheet className="w-4 h-4 mr-2" /> Excel出力</button>
                  <button onClick={() => window.print()} className="flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-medium text-sm"><Printer className="w-4 h-4 mr-2" /> 印刷</button>
                  
                  {!isLocked ? (
                    <>
                      <button onClick={() => {
                        setConfirmState({
                          isOpen: true,
                          message: '一時保存してもよろしいですか？',
                          onConfirm: () => { onSave('temporary'); setConfirmState({ ...confirmState, isOpen: false }); },
                          onCancel: () => setConfirmState({ ...confirmState, isOpen: false })
                        });
                      }} className="flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-medium text-sm"><Save className="w-4 h-4 mr-2" /> 一時保存</button>
                      <button onClick={() => {
                        setConfirmState({
                          isOpen: true,
                          message: '提出してもよろしいですか？',
                          onConfirm: () => { onSave('submit'); setConfirmState({ ...confirmState, isOpen: false }); },
                          onCancel: () => setConfirmState({ ...confirmState, isOpen: false })
                        });
                      }} className="flex items-center px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow font-medium text-sm ml-2"><Send className="w-4 h-4 mr-2" /> 提出</button>
                    </>
                  ) : (
                    <div className="flex items-center px-3 py-2 bg-gray-100 border border-gray-300 rounded text-gray-500 font-bold text-sm shadow-inner cursor-not-allowed">
                       <Lock className="w-4 h-4 mr-2" /> ロック中
                    </div>
                  )}
                </div>
              </div>

              <div className="bg-white p-10 shadow-2xl print-full print:p-0 text-sm leading-relaxed border border-gray-300 print:border-none relative min-h-[1300px]">
                <div className="absolute top-6 right-6 text-[10px] text-gray-400 font-mono">{safeText(header.formId)}</div>
                
                <div className="flex justify-between items-start mb-6">
                  <div className="flex-1 pt-2">
                    <div className="flex items-end space-x-4 mb-4">
                      <h1 className="text-3xl font-serif font-bold tracking-widest border-b-4 border-double border-black pb-1 inline-block">
                        {mode === 'rental' ? 'レンタル受注兼発送依頼書' : (mode === 'communication' ? '通信費 受注兼発送依頼書' : '受注兼発送依頼書')}
                        {isTemporary && <span className="text-red-600 ml-2">【仮】</span>}
                        {isReplacement && <span className="text-red-600 ml-2">【差替】</span>}
                        {isSubmitted && <span className="text-blue-600 ml-2">【提出済】</span>}
                      </h1>
                    </div>
                    
                    <div className="flex items-end flex-wrap gap-4 text-base mb-2">
                      <div className="flex items-center">
                        <span className="font-bold mr-2 text-sm">受注No.</span>
                        <input type="text" value={header.orderNo || ''} onChange={e => updateHeader('orderNo', e.target.value)} disabled={isLocked} className={`font-mono text-2xl font-bold border-b-2 border-black bg-transparent focus:outline-none w-48 ${isLocked ? 'input-locked' : ''}`} />
                      </div>
                      <div className="flex items-center self-end pb-1"><span className="font-bold mr-2 text-sm">見積書No.</span><input type="text" value={header.estimateNo || ''} onChange={e => updateHeader('estimateNo', e.target.value)} disabled={isLocked} className={`font-mono border-b border-gray-300 w-32 bg-transparent focus:outline-none text-lg ${isLocked ? 'input-locked' : ''}`} /></div>
                      {mode === 'sales' && (
                        <>
                          <div className="flex items-center self-end pb-1"><span className="font-bold mr-2 text-sm">売上日</span><input type="text" value={header.salesDate || ''} onChange={e => updateHeader('salesDate', e.target.value)} disabled={isLocked} className="font-mono border-b border-gray-300 w-24 text-center bg-transparent focus:outline-none" /></div>
                          <div className="flex items-center self-end pb-1"><span className="font-bold mr-2 text-sm">伝票No</span><input type="text" value={header.headerSlipNo || ''} onChange={e => updateHeader('headerSlipNo', e.target.value)} disabled={isLocked} className="font-mono border-b border-gray-300 w-24 text-center bg-transparent focus:outline-none" /></div>
                        </>
                      )}
                    </div>
                  </div>
                  <div className="flex flex-col items-end">
                    <div className="flex items-end gap-3 mb-2">
                       <Stamp title="担当" info={{...header.approvalStaff, status: header.shipRep ? '済' : '', name: header.shipRep, date: header.date}} className="border border-black shadow-sm" />
                       <div className="flex flex-col items-end pb-1 text-gray-700">
                          <div className="flex items-center"><span className="mr-2 text-xs">作成日:</span><span className="font-mono border-b border-gray-300 min-w-[6rem] text-right text-sm">{safeText(header.date)}</span></div>
                       </div>
                    </div>
                    <div className="flex border border-black shadow-sm">
                      <Stamp title="作成" info={header.approvalCreator} stampKey="Creator" /><Stamp title="確認" info={header.approvalCheck} stampKey="Check" /><div className="w-1 border-l border-black bg-gray-200"></div><Stamp title="部長" info={header.approvalManager} stampKey="Manager" /><Stamp title="社長" info={header.approvalPresident} stampKey="President" />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-12 border-2 border-black mb-4">
                  <div className="col-span-6 border-r border-black flex flex-col">
                    <div className="border-b border-black p-3">
                      <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max mb-1">社名</div>
                      <div className="px-2">
                        <input className={`font-bold text-xl leading-tight w-full outline-none bg-transparent ${isLocked ? 'input-locked' : ''}`} value={header.customerName || ''} onChange={e => updateHeader('customerName', e.target.value)} disabled={isLocked} placeholder="得意先名" />
                      </div>
                    </div>
                    <div className="border-b border-black p-3 flex-1">
                      <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max mb-2">住所</div>
                      <div className="px-2 text-sm">
                        <div className="flex items-center mb-1">〒<input className="ml-1 bg-transparent outline-none" value={header.customerZipCode || ''} onChange={e => updateHeader('customerZipCode', e.target.value)} disabled={isLocked} placeholder="000-0000" /></div>
                        <textarea className={`text-base mb-2 w-full bg-transparent outline-none resize-none overflow-hidden ${isLocked ? 'input-locked' : ''}`} rows="2" value={header.customerAddress || ''} onChange={e => updateHeader('customerAddress', e.target.value)} disabled={isLocked} placeholder="住所" />
                        <div className="flex gap-4 text-xs font-bold text-gray-600 mt-2">
                           <span>TEL: <input className="bg-transparent outline-none font-normal" value={header.customerTel || ''} onChange={e => updateHeader('customerTel', e.target.value)} disabled={isLocked} /></span>
                           <span>FAX: <input className="bg-transparent outline-none font-normal" value={header.customerFax || ''} onChange={e => updateHeader('customerFax', e.target.value)} disabled={isLocked} /></span>
                        </div>
                      </div>
                      <div className="mt-2 border-t border-gray-300 pt-1 px-2">
                          <div className="flex justify-between items-center mb-0.5">
                            <div className="text-[10px] font-bold text-gray-500">得意先備考</div>
                            <div className="text-[9px] font-bold text-red-500">※営業事務用</div>
                          </div>
                          <textarea 
                            className={`w-full bg-transparent outline-none resize-none text-sm text-red-600 font-bold bg-red-50 ${!isAdmin ? 'cursor-not-allowed opacity-70' : ''}`} 
                            rows="2" 
                            value={header.customerNote || ''} 
                            onChange={e => updateHeader('customerNote', e.target.value)} 
                            disabled={isLocked || !isAdmin} 
                          />
                      </div>
                    </div>
                    <div className="p-3 bg-gray-50 h-16 flex items-center gap-2">
                       <div className="flex items-center gap-1 flex-1">
                         <span className="text-[10px] bg-label px-1 py-1 rounded font-bold border border-gray-300 whitespace-nowrap">先方担当</span>
                         <input className="font-bold border-b border-gray-300 px-1 w-full text-sm bg-transparent outline-none" value={header.salesRepClient || ''} onChange={e => updateHeader('salesRepClient', e.target.value)} disabled={isLocked} />
                       </div>
                       <div className="flex items-center gap-1 flex-1">
                         <span className="text-[10px] bg-label px-1 py-1 rounded font-bold border border-gray-300 whitespace-nowrap">営業担当</span>
                         <input className="font-bold border-b border-gray-300 px-1 w-full text-sm bg-transparent outline-none" value={header.salesRepInternalMain || ''} onChange={e => updateHeader('salesRepInternalMain', e.target.value)} disabled={isLocked} />
                       </div>
                    </div>
                  </div>
                  
                  <div className="col-span-6 flex flex-col">
                    <div className="border-b border-black flex-1 p-3">
                       <div className="flex justify-between items-start mb-2">
                          <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max">直送先</div>
                          <div className="flex items-center gap-2 w-1/2">
                             <span className="text-xs font-bold text-gray-500 whitespace-nowrap">担当者:</span>
                             <input className="font-bold border-b border-gray-300 px-1 w-full text-sm bg-transparent outline-none" value={header.shipRep || ''} onChange={e => updateHeader('shipRep', e.target.value)} disabled={isLocked} placeholder="直送先担当者名" />
                          </div>
                       </div>
                       <div className="px-2 text-sm space-y-1">
                          <input className="font-bold text-base border-b border-dashed border-gray-300 pb-1 mb-1 w-full bg-transparent outline-none" value={header.shipName || ''} onChange={e => updateHeader('shipName', e.target.value)} disabled={isLocked} placeholder="(直送先名)" />
                          <textarea className="w-full bg-transparent outline-none resize-none" rows="2" value={header.shipAddress || ''} onChange={e => updateHeader('shipAddress', e.target.value)} disabled={isLocked} placeholder="住所" />
                       </div>
                    </div>
                    <div className="p-3 pb-2 border-t border-black bg-yellow-50">
                        <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max mb-2">売上先の集金条件</div>
                        <div className="grid grid-cols-2 gap-4 px-2 mb-2">
                           <div className="flex items-center">
                             <span className="font-bold text-sm mr-2 w-16 text-right">締め日:</span>
                             {/* selectタグのvalueが header.closingDate と一致するように型を合わせる */}
                             <select 
                               value={header.closingDate ? String(header.closingDate) : ''} 
                               onChange={e => updateHeader('closingDate', e.target.value)} 
                               disabled={isLocked} 
                               className="border-b border-gray-400 flex-1 text-center bg-transparent font-bold outline-none"
                             >
                               <option value=""></option>
                               {[...Array(31)].map((_, i) => (
                                 <option key={i + 1} value={String(i + 1)}>{i + 1}</option>
                               ))}
                               <option value="末日">末日</option>
                             </select>
                           </div>
                           <div className="flex items-center">
                             <span className="font-bold text-sm mr-2 w-16 text-right">支払日:</span>
                             <input value={header.paymentDate || ''} onChange={e => updateHeader('paymentDate', e.target.value)} disabled={isLocked} className="border-b border-gray-400 flex-1 text-center bg-transparent outline-none" list="payment-dates" />
                           </div>
                        </div>
                        <div className="flex mt-2 px-2 items-start">
                          <span className="font-bold text-sm mr-2 mt-1 whitespace-nowrap">支払条件:</span>
                          <div className="flex-1 border border-black rounded bg-white">
                            <div className="border-b border-gray-300">
                               <select className="w-full bg-transparent px-2 py-1 text-sm font-bold outline-none" value={paymentConditionType} onChange={e => updatePaymentType(e.target.value)} disabled={isLocked}><option value="従来通り">従来通り</option><option value="従来通り以外">従来通り以外</option></select>
                            </div>
                            <div><input type="text" list="payment-details" className="w-full bg-transparent px-2 py-1 text-sm outline-none" placeholder="(詳細を入力)" value={paymentConditionDetail} onChange={e => updatePaymentDetail(e.target.value)} disabled={isLocked} /></div>
                          </div>
                        </div>
                    </div>
                  </div>
                </div>

                <div className="border-2 border-black mb-4">
                  <div className="bg-white p-2">
                    <div className={`grid gap-x-2 text-center text-xs font-bold text-gray-600 mb-1 ${mode === 'rental' ? 'grid-cols-[20px_1fr_1fr_1fr_1fr_0.7fr]' : 'grid-cols-[20px_1fr_1fr_1fr_1fr_0.7fr_0.7fr]'}`}>
                      <div></div><div className="bg-gray-100 rounded py-0.5 border border-gray-200">出荷日</div><div className="bg-gray-100 rounded py-0.5 border border-gray-200">納期</div><div className="bg-gray-100 rounded py-0.5 border border-gray-200">配送方法</div><div className="bg-gray-100 rounded py-0.5 border border-gray-200">時間帯</div>{mode !== 'rental' && <div className="bg-gray-100 rounded py-0.5 border border-gray-200">情報No</div>}<div className="bg-gray-100 rounded py-0.5 border border-gray-200">出荷No</div>
                    </div>
                    {[...Array(shippingRowCount)].map((_, i) => {
                      const num = i + 1;
                      return (
                        <div key={num} className={`grid gap-x-2 items-center mb-1 last:mb-0 ${mode === 'rental' ? 'grid-cols-[20px_1fr_1fr_1fr_1fr_0.7fr]' : 'grid-cols-[20px_1fr_1fr_1fr_1fr_0.7fr_0.7fr]'}`}>
                          <div className="text-center font-bold text-[10px] rounded-full bg-gray-100 w-5 h-5 flex items-center justify-center border border-gray-200">{num}</div>
                          <div><input className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`shipDate${num}`] || ''} onChange={e => updateHeader(`shipDate${num}`, e.target.value)} disabled={isLocked} placeholder="yyyy/mm/dd" /></div>
                          <div><input className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`deliveryDate${num}`] || ''} onChange={e => updateHeader(`deliveryDate${num}`, e.target.value)} disabled={isLocked} placeholder="yyyy/mm/dd" /></div>
                          <div><input list="shipping-methods" className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`deliveryMethod${num}`] || ''} onChange={e => updateHeader(`deliveryMethod${num}`, e.target.value)} disabled={isLocked} /></div>
                          <div>
                            <select className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-xs" value={header[`deliveryTime${num}`] || ''} onChange={e => updateHeader(`deliveryTime${num}`, e.target.value)} disabled={isLocked}>
                                <option value="">指定なし</option><option value="午前中">午前中</option><option value="14時～16時">14時～16時</option><option value="16時～18時">16時～18時</option><option value="18時以降">18時以降</option>
                            </select>
                          </div>
                          {mode !== 'rental' && <div><input className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`informationNo${num}`] || ''} onChange={e => updateHeader(`informationNo${num}`, e.target.value)} disabled={isLocked} /></div>}
                          <div><input className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm font-mono" value={header[`shippingNo${num}`] || ''} onChange={e => updateHeader(`shippingNo${num}`, e.target.value)} disabled={isLocked} /></div>
                        </div>
                      );
                    })}
                    <div className="text-center mt-1 print-hidden"><button onClick={addShippingRow} disabled={isLocked} className="text-blue-500 text-xs hover:underline"><Plus className="w-3 h-3 inline mr-1" />行を追加</button></div>
                  </div>
                  <div className="h-16 flex border-t border-black">
                      <div className="text-xs bg-label px-2 py-2 rounded-sm font-bold border-r border-black writing-vertical-lr text-center flex items-center justify-center m-0.5">技術課<br/>依頼書</div>
                      <div className="flex-1 p-2 flex items-center"><input type="text" list="tech-requests" value={header.internalMemo || ''} onChange={e => updateHeader('internalMemo', e.target.value)} disabled={isLocked} className="w-full text-sm bg-transparent border-b border-gray-300 p-1 focus:border-blue-500 outline-none transition-colors" placeholder="(選択または入力)"/></div>
                  </div>
                </div>

                <div className="border-2 border-black mb-6">
                  <div className={`grid ${gridColsClass} bg-label border-b border-black text-center font-bold py-2 text-sm`}>
                    <div className="text-[10px] text-gray-500">操作</div>
                    <div className="border-l border-black border-r px-1 text-[10px] flex items-center justify-center">取引年月日</div>
                    <div className="border-r border-black px-1">品 名</div>
                    {mode !== 'sales' && <div className="border-r border-black">規格</div>}
                    <div className="border-r border-black">数量</div><div className="border-r border-black">単位</div><div className="border-r border-black">単価</div><div className="border-r border-black">金額</div>
                    <div className="border-r border-black">原価金額</div>
                    {mode !== 'sales' && <div>備考</div>}
                  </div>
                  {items.map((row, i) => {
                    const isManual = String(row.id).includes('-');
                    const canEditRow = isManual ? !isSubmitted : !isLocked;
                    return (
                      <div key={row.id} className={`grid ${gridColsClass} border-b border-black last:border-none text-sm min-h-[32px] group`}>
                        <div className="flex items-center justify-center"><button onClick={() => deleteItem(i)} className={`opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 print-hidden ${isLocked ? 'hidden' : ''}`}><Trash2 className="w-4 h-4" /></button></div>
                        <div className="border-l border-black border-r p-1"><input className={`w-full text-center bg-transparent outline-none text-xs font-mono ${!canEditRow ? 'text-gray-400' : ''}`} value={row.transactionDate || ''} onChange={e => updateItem(i, 'transactionDate', e.target.value)} placeholder="MM/DD" readOnly={!canEditRow} /></div>
                        <div className="border-r border-black p-1 pl-3 flex flex-col justify-center"><input className={`w-full bg-transparent outline-none font-medium ${!canEditRow ? 'text-gray-500' : ''}`} value={row.productName || ''} onChange={e => updateItem(i, 'productName', e.target.value)} readOnly={!canEditRow} /></div>
                        {mode !== 'sales' && <div className="border-r border-black p-1"><input className="w-full text-center bg-transparent outline-none text-xs" value={row.spec || ''} onChange={e => updateItem(i, 'spec', e.target.value)} readOnly={!canEditRow} /></div>}
                        <div className="border-r border-black p-1"><NumberInput className="w-full bg-transparent outline-none font-mono" value={row.quantity || ''} onChange={v => updateItem(i, 'quantity', v)} readOnly={!canEditRow} /></div>
                        <div className="border-r border-black p-1"><input className="w-full text-center bg-transparent outline-none" value={row.unit || ''} onChange={e => updateItem(i, 'unit', e.target.value)} readOnly={!canEditRow} /></div>
                        <div className="border-r border-black p-1"><NumberInput className="w-full bg-transparent outline-none font-mono" value={row.unitPrice || ''} onChange={v => updateItem(i, 'unitPrice', v)} readOnly={!canEditRow} isMasked={isTemporary} /></div>
                        <div className="border-r border-black p-1 px-2 text-right font-mono font-bold flex items-center justify-end">{isTemporary ? '0' : (row.amount ? Number(row.amount).toLocaleString() : '')}</div>
                        <div className="border-r border-black p-1"><NumberInput className="w-full bg-transparent outline-none font-mono text-xs text-gray-500" value={row.costAmount || ''} onChange={v => updateItem(i, 'costAmount', v)} placeholder="-" readOnly={!canEditRow} /></div>
                        {mode !== 'sales' && <div className="p-1 border-r border-black flex items-center"><input className="w-full bg-transparent outline-none text-xs" value={row.note || ''} onChange={e => updateItem(i, 'note', e.target.value)} readOnly={!canEditRow} /></div>}
                      </div>
                    );
                  })}
                  {[...Array(Math.max(0, 5 - items.length))].map((_, i) => (
                      <div key={`empty-${i}`} className={`grid ${gridColsClass} border-b border-black last:border-none text-sm min-h-[32px]`}><div/><div className="border-l border-black border-r"/><div className="border-r border-black"/><div className="border-r border-black"/><div className="border-r border-black"/><div className="border-r border-black"/><div className="border-r border-black font-mono"/><div className="border-r border-black"/><div/></div>
                  ))}
                  
                  <div className="border-t border-black p-2 flex flex-col items-end pr-8 bg-gray-50">
                    <div className="flex space-x-6 items-center">
                      <div className="flex items-center"><span className="text-xs font-bold mr-2">小計</span><span className="font-mono text-base">{isTemporary ? '0' : totals.subtotal.toLocaleString()}</span></div>
                      <div className="flex items-center"><span className="text-xs font-bold mr-2">消費税</span><span className="font-mono text-base">{isTemporary ? '0' : totals.tax.toLocaleString()}</span></div>
                      <div className="flex items-center"><span className="text-sm font-bold mr-2">合計</span><span className="font-mono text-xl font-bold">{isTemporary ? '0' : totals.total.toLocaleString()} 円</span></div>
                    </div>
                    {mode === 'sales' && (
                      <div className="mt-1 pt-1 border-t border-gray-300 w-48 flex justify-end items-center">
                        <span className="text-[10px] font-bold text-gray-500 mr-2">原価計:</span><span className="font-mono text-xs">{isTemporary ? '0' : items.reduce((sum, item) => sum + (Number(item.costAmount) || 0), 0).toLocaleString()} 円</span>
                      </div>
                    )}
                  </div>
                  <div className="p-1 bg-white print-hidden text-center"><button onClick={() => { if(!isLocked) onChange({...data, items: [...items, { id: generateId(), productName: '', transactionDate: '', quantity: '', unit: '', unitPrice: '', amount: 0, costAmount: 0 }]})}} disabled={isLocked} className="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center justify-center w-full"><Plus className="w-3 h-3 mr-1" /> 明細を追加</button></div>
                </div>

                <div className="border border-black p-3 mb-4">
                  <div className="text-xs font-bold border-b border-black mb-2 flex justify-between items-center bg-label px-2 py-1">
                    <span>備考 / 履歴</span><button onClick={() => { if(!isLocked) onChange({...data, remarks: [...remarks, { id: generateId(), category: 'その他', content: '', date: new Date().toISOString().split('T')[0].replace(/-/g, '/'), status: '', mailSent: '' }]})}} disabled={isLocked} className="text-blue-600 flex items-center text-[10px] border border-blue-200 px-1 bg-white rounded"><Plus className="w-3 h-3 mr-1" /> 追加</button>
                  </div>
                  <div className="w-full text-sm">
                    <div className="grid grid-cols-[80px_100px_1fr_100px_140px_30px] gap-2 border-b border-gray-300 pb-1 mb-1 font-bold text-[10px] text-gray-500 text-center"><div>カテゴリ</div><div>日時</div><div>内容</div><div>状況</div><div>メール送付</div><div/></div>
                    <div className="overflow-y-auto max-h-48 space-y-1">
                      {remarks.map((rmk, idx) => (
                        <div key={rmk.id} className="grid grid-cols-[80px_100px_1fr_100px_140px_30px] gap-2 items-center hover:bg-gray-50 p-1 border-b border-gray-100 last:border-none">
                          <div><select className="w-full border border-gray-300 text-[10px] p-0.5 bg-white" value={rmk.category || 'その他'} onChange={e => updateRemark(idx, 'category', e.target.value)} disabled={isLocked}><option value="請求">請求</option><option value="出荷">出荷</option><option value="その他">その他</option></select></div>
                          <div><input className="w-full border-b border-gray-200 text-[10px] text-center" value={rmk.date || ''} onChange={e => updateRemark(idx, 'date', e.target.value)} disabled={isLocked} /></div>
                          <div><input className="w-full border-b border-gray-200 text-xs" value={rmk.content || ''} onChange={e => updateRemark(idx, 'content', e.target.value)} disabled={isLocked} /></div>
                          <div><input className="w-full border-b border-gray-200 text-[10px] text-center" value={rmk.status || ''} onChange={e => updateRemark(idx, 'status', e.target.value)} disabled={isLocked} /></div>
                          <div className="flex items-center gap-1"><input className="flex-1 border-b border-gray-200 text-[9px]" value={rmk.mailSent || ''} onChange={e => updateRemark(idx, 'mailSent', e.target.value)} disabled={isLocked} /><button onClick={() => { const now = new Date(); updateRemark(idx, 'mailSent', "済: " + (now.getMonth()+1) + "/" + now.getDate()); }} disabled={isLocked} className="text-blue-500"><Mail className="w-3 h-3" /></button></div>
                          <div className="text-center"><button onClick={() => { const newRemarks = [...remarks]; newRemarks.splice(idx, 1); onChange({...data, remarks: newRemarks}); }} disabled={isLocked} className="text-gray-300 hover:text-red-500"><Trash2 className="w-3 h-3" /></button></div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

              </div>
          </div>
        );
      };

      // 親コンポーネント (タブ管理)
      function App() {
        const [tabs, setTabs] = useState([]);
        const [activeTabId, setActiveTabId] = useState(null);
        const [saveStatus, setSaveStatus] = useState('idle');
        const [loading, setLoading] = useState(true);
        const [addMenuOpen, setAddMenuOpen] = useState(false);

        useEffect(() => {
          if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler((data) => {
              const loadingEl = document.getElementById('loading');
              if (loadingEl) loadingEl.style.display = 'none';
              
              const tid = generateId();
              const initialStatus = data.header?.dataStatus || 'official';
              const initialMode = CONFIG.initialSummaryCode === '65' ? 'rental' : (data.mode || 'sales');
              
              setTabs([{ 
                id: tid, 
                title: initialMode === 'rental' ? 'レンタル' : (initialMode === 'sales' ? '販売' : '通信'), 
                mode: initialMode, 
                data: { ...data, header: { ...data.header, dataStatus: initialStatus } } 
              }]);
              setActiveTabId(tid);
              setLoading(false);
            }).getOrderData(CONFIG.initialOrderNo, CONFIG.initialSummaryCode);
          } else {
            setTimeout(() => {
               const loadingEl = document.getElementById('loading');
               if (loadingEl) loadingEl.style.display = 'none';
               setLoading(false);
            }, 800);
          }
        }, []);

        const addNewTab = (newMode) => {
           const currentTab = tabs.find(t => t.id === activeTabId);
           const newId = generateId();
           const newTitle = newMode === 'rental' ? 'レンタル' : (newMode === 'communication' ? '通信費' : '販売');
           const newData = JSON.parse(JSON.stringify(currentTab.data));
           newData.mode = newMode;
           newData.header.dataStatus = 'official';
           setTabs([...tabs, { id: newId, title: newTitle, mode: newMode, data: newData }]);
           setActiveTabId(newId);
           setAddMenuOpen(false);
        };

        const handleSave = (type) => {
          const target = tabs.find(t => t.id === activeTabId);
          if(!target) return;
          
          setSaveStatus('saving');
          const finalStatus = type === 'submit' ? 'submitted' : target.data.header.dataStatus;
          const finalData = { 
            ...target.data, 
            header: { ...target.data.header, dataStatus: finalStatus },
            userName: CONFIG.userName,
            mode: target.mode 
          };

          if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(() => { 
              setSaveStatus('saved'); 
              setTabs(prev => prev.map(t => t.id === activeTabId ? { ...t, data: finalData } : t));
              setTimeout(()=>setSaveStatus('idle'), 3000); 
            }).saveOrderData(finalData);
          }
        };

        if (loading) return null;

        return (
          <div className="min-h-screen bg-gray-200 p-6 flex flex-col items-center pb-40">
            <div id="tab-bar" className="w-full max-w-[1100px] flex items-end space-x-1 mb-0 print-hidden">
               {tabs.map(tab => (
                 <div key={tab.id} onClick={() => setActiveTabId(tab.id)} className={`px-6 py-2 rounded-t-lg font-bold text-sm cursor-pointer border-t border-x relative transition-all ${activeTabId === tab.id ? 'tab-active shadow-sm -mb-px z-10' : 'tab-inactive bg-gray-300 hover:bg-gray-100'}`} style={{ height: '42px' }}>
                    <span className="mr-2">{tab.title}</span>
                 </div>
               ))}
               <div className="relative">
                 <button onClick={() => setAddMenuOpen(!addMenuOpen)} className="px-3 py-2 bg-gray-600 text-white rounded-t-lg hover:bg-gray-700 transition-colors flex items-center h-[42px] font-bold text-xs"><Plus className="w-4 h-4 mr-1" /> 追加</button>
                 {addMenuOpen && (
                   <div className="absolute top-10 left-0 bg-white shadow-xl rounded border border-gray-300 w-32 z-50 overflow-hidden">
                      <button onClick={() => addNewTab('sales')} className="block w-full text-left px-4 py-2 hover:bg-blue-50 text-sm">販売</button>
                      <button onClick={() => addNewTab('rental')} className="block w-full text-left px-4 py-2 hover:bg-green-50 text-sm">レンタル</button>
                      <button onClick={() => addNewTab('communication')} className="block w-full text-left px-4 py-2 hover:bg-purple-50 text-sm">通信費</button>
                   </div>
                 )}
               </div>
            </div>
            {tabs.map(tab => (
              <SingleOrderSheet key={tab.id} tabId={tab.id} data={tab.data} isActive={activeTabId === tab.id} currentUser={{role: CONFIG.userRole}}
                onChange={(newData) => setTabs(prev => prev.map(t => t.id === tab.id ? {...t, data: newData} : t))} 
                onSave={handleSave} onExportExcel={() => { if(typeof google !== 'undefined') google.script.run.generateOrderSheet(tab.data); }} saveStatus={saveStatus} />
            ))}
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
