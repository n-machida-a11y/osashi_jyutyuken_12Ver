<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>受注兼発送依頼書</title>
    
    <!-- ライブラリ読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@700&display=swap');
      body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
      .font-serif { font-family: 'Noto Serif JP', serif; }
      
      .border-black { border-color: #000 !important; }
      .bg-label { background-color: #e5e7eb; }
      
      .text-base-plus { font-size: 1.1rem; }
      .text-sm-plus { font-size: 0.95rem; }
      .text-xs-plus { font-size: 0.85rem; }

      #debug-log {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
        background: #111; color: #0f0; font-family: monospace; font-size: 11px;
        overflow-y: auto; padding: 10px; z-index: 9999; opacity: 0.9;
        border-top: 2px solid #444; display: none; 
      }

      @media print {
        .print-hidden { display: none !important; }
        .print-full { width: 100% !important; max-width: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; border: none !important; }
        @page { size: A4; margin: 10mm; }
        body { background: white; -webkit-print-color-adjust: exact; }
        #debug-log { display: none !important; }
        input, select, textarea { border-bottom: none !important; }
        select { appearance: none; border: none; background: transparent; padding: 0; }
        #tab-bar { display: none !important; }
      }
      .writing-vertical-lr { writing-mode: vertical-lr; }
      
      .fade-out { animation: fadeOut 2s forwards; }
      @keyframes fadeOut {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; }
      }
      
      .tab-active {
        background-color: white;
        border-bottom-color: white;
        color: #2563eb;
      }
      .tab-inactive {
        background-color: #f3f4f6;
        border-bottom-color: #d1d5db;
        color: #6b7280;
      }
      .tab-inactive:hover {
        background-color: #e5e7eb;
      }
    </style>
  </head>
  <body>
    <div id="global-error"></div>
    <div id="root"></div>
    <div id="loading">
      <div class="spinner"></div>
      <div class="text-lg font-bold">システムを起動中...</div>
      <div style="font-size:12px; color:#999; margin-top:10px; text-align:center;">
        画面が変わらない場合はブラウザを更新してください。<br>
        (受注No: <?= initialOrderNo ?>)
      </div>
    </div>
    <div id="debug-log"></div>

    <datalist id="closing-dates"><option value="10日"/><option value="20日"/><option value="末日"/></datalist>
    <datalist id="payment-dates">
      <option value="当月末"/><option value="翌月10日"/><option value="翌月20日"/><option value="翌月末"/><option value="翌々月10日"/>
    </datalist>
    <datalist id="payment-details">
      <option value="現金"/><option value="振込"/><option value="手形"/><option value="手形　サイト90日"/><option value="手形　サイト120日"/>
      <option value="手形　サイト115日"/><option value="10万以上手形　サイト70日"/><option value="10万以上手形　サイト90日"/>
      <option value="10万以上手形　サイト97日"/><option value="10万以上手形　サイト120日"/><option value="50万以上半金半手サイト115日"/><option value="10万以上手形"/>
    </datalist>
    <datalist id="tech-requests">
      <option value="機械器具設置" /><option value="電気通信" /><option value="保守点検" /><option value="修繕" /><option value="その他" />
    </datalist>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      // Icons
      const IconWrapper = ({ children, className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
      );
      const Printer = ({ className }) => <IconWrapper className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconWrapper>;
      const Save = ({ className }) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
      const FileSpreadsheet = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconWrapper>;
      const Plus = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
      const Trash2 = ({ className }) => <IconWrapper className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
      const Calculator = ({ className }) => <IconWrapper className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>;
      const CloudCheck = ({ className }) => <IconWrapper className={className}><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="9 11 12 14 22 4"/></IconWrapper>;
      const Loader = ({ className }) => <IconWrapper className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconWrapper>;
      const Mail = ({ className }) => <IconWrapper className={className}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconWrapper>;
      const X = ({ className }) => <IconWrapper className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>;
      const Clock = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;

      // GASパラメータ安全受け取り
      let INITIAL_ORDER_NO = "";
      let INITIAL_SUMMARY_CODE = "";
      const cleanParam = (val) => String(val).replace(/^["']+|["']+$/g, '');

      try {
        INITIAL_ORDER_NO = <?= JSON.stringify(initialOrderNo) ?> || "";
        INITIAL_SUMMARY_CODE = <?= JSON.stringify(initialSummaryCode) ?> || "";
        INITIAL_ORDER_NO = cleanParam(INITIAL_ORDER_NO);
        INITIAL_SUMMARY_CODE = cleanParam(INITIAL_SUMMARY_CODE);
      } catch (e) {
        console.error("Param Error", e);
      }

      // --- ユーティリティ関数 ---
      const generateId = () => crypto.randomUUID();
      const safeText = (val) => (val === undefined || val === null) ? '' : String(val);

      // --- サブコンポーネント: 個別の受注シート ---
      const SingleOrderSheet = ({ data, isActive, onChange, onSave, onExportExcel, allTabs, tabId, saveStatus }) => {
        const { mode, header, items, schedule, remarks, totals, paymentConditionType, paymentConditionDetail } = data;
        
        const [isIndefinite, setIsIndefinite] = useState(false);

        // 計算ロジック
        const calculateMonths = (start, end) => {
          if(!start || !end) return 0;
          try {
            const d1 = new Date(start);
            const d2 = new Date(end);
            if(isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0;
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return Math.round(diffDays / 30) || 0;
          } catch(e) { return 0; }
        };
        const periodMonths = useMemo(() => calculateMonths(header.periodStartDate, header.periodEndDate), [header.periodStartDate, header.periodEndDate]);

        const updateData = (updates) => {
          onChange({ ...data, ...updates });
        };
        const updateHeader = (key, val) => updateData({ header: { ...header, [key]: val } });
        const updatePaymentType = (val) => updateData({ paymentConditionType: val });
        const updatePaymentDetail = (val) => updateData({ paymentConditionDetail: val });

        const updateItem = (idx, key, val) => {
          const newItems = [...items];
          newItems[idx] = { ...newItems[idx], [key]: val };
          
          if (['quantity', 'unitPrice'].includes(key)) {
             const qty = Number(newItems[idx].quantity) || 0;
             const price = Number(newItems[idx].unitPrice) || 0;
             newItems[idx].amount = qty * price;
          }
          if (['quantity', 'costPrice'].includes(key)) {
             const qty = Number(newItems[idx].quantity) || 0;
             const cPrice = Number(newItems[idx].costPrice) || 0;
             newItems[idx].costAmount = qty * cPrice;
          }
          const subtotal = newItems.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                         + schedule.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
          const tax = Math.floor(subtotal * 0.1);
          onChange({ ...data, items: newItems, totals: { subtotal, tax, total: subtotal + tax } });
        };
        
        const deleteItem = (idx) => {
          const newItems = [...items];
          newItems.splice(idx, 1);
          const subtotal = newItems.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                         + schedule.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
          const tax = Math.floor(subtotal * 0.1);
          onChange({ ...data, items: newItems, totals: { subtotal, tax, total: subtotal + tax } });
        };

        const updateSchedule = (idx, key, val) => {
          const newSched = [...schedule];
          newSched[idx] = { ...newSched[idx], [key]: val };
          onChange({ ...data, schedule: newSched });
        };
        const addScheduleRow = () => {
          const lastRow = schedule[schedule.length - 1];
          const defaultCount = (lastRow && lastRow.count === '延長') ? '1回目' : '';
          
          const newSched = [...schedule, {
             id: generateId(), count: defaultCount, billingDate: '', amount: '', costReference: '', slipNo: '', closingDate: '', note: '', checkStatus: ''
          }];
          onChange({ ...data, schedule: newSched });
        };
        const addExtensionRow = () => {
          const newSched = [...schedule, {
             id: generateId(), count: '延長', billingDate: '', amount: '', costReference: '', slipNo: '', closingDate: '', note: '', checkStatus: ''
          }];
          onChange({ ...data, schedule: newSched });
        };
        const removeScheduleRow = (idx) => {
          const newSched = [...schedule];
          newSched.splice(idx, 1);
          onChange({ ...data, schedule: newSched });
        };
        
        const updateRemark = (idx, key, val) => {
          const newRemarks = [...remarks];
          newRemarks[idx] = { ...newRemarks[idx], [key]: val };
          onChange({ ...data, remarks: newRemarks });
        };
        const addRemark = () => onChange({ ...data, remarks: [...remarks, { 
          id: generateId(), category: 'その他', content: '', date: new Date().toISOString().split('T')[0].replace(/-/g, '/'), status: '', mailSent: '' 
        }]});
        const deleteRemark = (idx) => {
          const newRemarks = [...remarks];
          newRemarks.splice(idx, 1);
          onChange({ ...data, remarks: newRemarks });
        };
        const markMailSent = (idx) => {
          const now = new Date();
          const timeStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
          updateRemark(idx, 'mailSent', "送信済: " + timeStr);
        };

        const handleAutoGenerateSchedule = () => {
          if (!header.periodStartDate && !isIndefinite) {
            alert("期間（開始日）を入力してください。");
            return;
          }
          if (!isIndefinite && !header.periodEndDate) {
             alert("期間（終了日）を入力するか、「終了まで」にチェックを入れてください。");
             return;
          }

          if (schedule.length > 0 && !confirm("現在のスケジュールをクリアして自動生成しますか？")) return;
          
          const months = isIndefinite ? 1 : periodMonths;
          if (months <= 0) {
            alert("期間が短すぎるか、日付が正しくありません。");
            return;
          }
          
          const monthlyAmount = items.reduce((sum, item) => sum + (Number(item.unitPrice) || 0), 0);
          const monthlyCost = items.reduce((sum, item) => sum + (Number(item.costPrice) || 0), 0);
          
          const newSchedule = [];
          const startDate = new Date(header.periodStartDate);
          
          for (let i = 0; i < months; i++) {
             const billDate = new Date(startDate);
             billDate.setMonth(startDate.getMonth() + i);
             const closeDate = new Date(billDate.getFullYear(), billDate.getMonth() + 1, 0);
             const formatDate = (d) => `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
             const formatClose = (d) => `${d.getMonth()+1}/末`;
             
             const isCommunication = mode === 'communication';
             const amountVal = (!isCommunication || i === 0) ? (monthlyAmount > 0 ? monthlyAmount : '') : '';
             const costVal = (!isCommunication || i === 0) ? (monthlyCost > 0 ? monthlyCost : '') : '';

             newSchedule.push({
               id: generateId(), count: (i + 1) + '回目', billingDate: formatDate(billDate), amount: amountVal, costReference: costVal, slipNo: '', closingDate: formatClose(closeDate), note: '', checkStatus: ''
             });
          }
          onChange({ ...data, schedule: newSchedule });
        };

        const Stamp = ({ title, info }) => (
          <div className="flex flex-col items-center justify-between border-l border-black w-16 h-20 bg-white">
            <div className="w-full text-center border-b border-black text-[11px] bg-label py-1 font-bold">{title}</div>
            <div className="flex-1 flex flex-col items-center justify-center w-full relative">
              {info && info.status === '済' ? (
                <div className="relative">
                  <div className="w-12 h-12 rounded-full border-2 border-red-600 flex flex-col items-center justify-center text-red-600 text-[9px] font-serif transform -rotate-12 select-none bg-white bg-opacity-90 leading-tight p-0.5 shadow-sm">
                    <span className="text-[10px]">{info.date}</span>
                    <span className="text-[10px] font-bold border-t border-red-600 w-10 text-center mt-0.5 pt-0.5 whitespace-nowrap overflow-hidden">
                      {info.name ? (info.name.split(' ').pop() || info.name) : '担当'}
                    </span>
                  </div>
                </div>
              ) : ( <span className="text-gray-200 text-xl font-bold">・</span> )}
            </div>
          </div>
        );

        const modeLabel = mode === 'sales' ? '販売品' : (mode === 'rental' ? 'レンタル' : '通信費');
        const borderColor = mode === 'rental' ? 'border-green-600' : (mode === 'communication' ? 'border-purple-600' : 'border-blue-600');
        const titleColor = mode === 'rental' ? 'text-green-700' : (mode === 'communication' ? 'text-purple-700' : 'text-blue-700');

        const itemsTotal = items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
        const monthlyTax = Math.floor(itemsTotal * 0.1);
        const monthlyTotal = itemsTotal + monthlyTax;

        const gridColsClass = mode === 'sales' 
           ? 'grid-cols-[30px_1fr_50px_50px_80px_80px_80px]' 
           : 'grid-cols-[30px_1fr_60px_50px_50px_80px_80px_80px_1fr]';

        const gridColsSchedule = 'grid-cols-[30px_3rem_9rem_7rem_6rem_4rem_1fr_3rem]';

        return (
          <div className={`w-full max-w-[1100px] print-full ${!isActive ? 'hidden' : ''}`}>
             <div className={`mb-6 bg-white p-4 rounded-lg shadow-md print-hidden flex justify-between items-center border-l-4 ${borderColor}`}>
                <div className="flex items-center space-x-4">
                  <div className="flex flex-col">
                    <span className={`font-bold ${titleColor} flex items-center text-lg`}>【{modeLabel}】</span>
                    <span className="text-xs text-gray-500">受注No: {header.orderNo}</span>
                  </div>
                </div>
                <div className="flex items-center space-x-3">
                  <div className="text-sm font-medium mr-2 flex items-center w-32 justify-end">
                    {saveStatus === 'saving' && <span className="text-blue-600 flex items-center animate-pulse"><Loader className="w-4 h-4 mr-1 animate-spin" /> 保存中...</span>}
                    {saveStatus === 'saved' && <span className="text-green-600 flex items-center fade-out"><CloudCheck className="w-4 h-4 mr-1" /> 保存完了</span>}
                    {saveStatus === 'error' && <span className="text-red-600">保存エラー</span>}
                  </div>
                  <button onClick={() => onExportExcel(tabId)} className="flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium text-sm shadow"><FileSpreadsheet className="w-4 h-4 mr-2" /> Excel出力</button>
                  <button onClick={() => window.print()} className="flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-medium text-sm"><Printer className="w-4 h-4 mr-2" /> 印刷</button>
                  <button onClick={() => onSave(tabId)} className="flex items-center px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-medium text-sm"><Save className="w-4 h-4 mr-2" /> 保存</button>
                </div>
              </div>

              <div className="bg-white p-10 shadow-2xl print-full print:p-0 text-sm leading-relaxed border border-gray-300 print:border-none relative min-h-[1300px]">
                <div className="absolute top-6 right-6 text-xs text-gray-400">{safeText(header.formId)}</div>
                <div className="flex justify-between items-start mb-6">
                  <div className="flex-1 pt-2">
                    <div className="flex items-end space-x-4 mb-4">
                      <h1 className="text-3xl font-serif font-bold tracking-widest border-b-4 border-double border-black pb-1 inline-block">
                        {mode === 'rental' ? 'レンタル受注兼発送依頼書' : (mode === 'communication' ? '通信費 受注兼発送依頼書' : '受注兼発送依頼書')}
                      </h1>
                      <div className="flex flex-col text-sm font-bold text-red-600 mb-1">
                        {header.tag && <span>{safeText(header.tag)}</span>}
                        {mode === 'communication' && <span>＜通信費＞</span>}
                      </div>
                    </div>
                    <div className="flex space-x-8 text-base mb-2">
                      <div className="flex items-center">
                        <span className="font-bold mr-2">受注No.</span>
                        <div className="flex flex-col">
                          <input type="text" value={header.orderNo || ''} onChange={e => updateHeader('orderNo', e.target.value)} className="font-mono text-2xl font-bold border-b-2 border-black bg-transparent focus:outline-none w-48" />
                          {mode === 'rental' && header.previousOrderNo && <span className="text-xs text-gray-500 mt-0.5 font-mono">(元受注: {header.previousOrderNo})</span>}
                        </div>
                      </div>
                      <div className="flex items-center self-start pt-2">
                        <span className="font-bold mr-2 text-sm">見積書No.</span>
                        <input type="text" value={header.estimateNo || ''} onChange={e => updateHeader('estimateNo', e.target.value)} className="font-mono border-b border-gray-300 w-32 bg-transparent focus:outline-none text-lg" />
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-col items-end">
                    <div className="flex gap-6 text-xs mb-4 text-gray-700">
                      <div className="flex flex-col items-end"><div className="flex items-center"><span className="mr-2">作成日:</span><span className="font-mono border-b border-gray-300 min-w-[6rem] text-right text-sm">{safeText(header.date)}</span></div></div>
                    </div>
                    <div className="flex border border-black shadow-sm">
                      <Stamp title="作成" info={header.approvalCreator} /><Stamp title="確認" info={header.approvalCheck} /><div className="w-1 border-l border-black bg-gray-200"></div><Stamp title="部長" info={header.approvalManager} /><Stamp title="社長" info={header.approvalPresident} />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-12 border-2 border-black mb-4">
                  <div className="col-span-6 border-r border-black flex flex-col">
                    <div className="border-b border-black p-3">
                      <div className="flex justify-between items-start mb-1">
                        <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300">社名</div>
                        <div className="text-xs text-gray-400">Code: {safeText(header.customerCode)}</div>
                      </div>
                      <div className="px-2">
                        <input className="font-bold text-xl leading-tight w-full outline-none bg-transparent" value={header.customerName || ''} onChange={e => updateHeader('customerName', e.target.value)} placeholder="得意先名" />
                        <div className="flex gap-4 text-sm mt-1 text-gray-700">
                          <input className="bg-transparent outline-none border-b border-transparent hover:border-gray-300 focus:border-gray-400 w-1/2" value={header.customerBranch || ''} onChange={e => updateHeader('customerBranch', e.target.value)} placeholder="支店名" />
                          <input className="bg-transparent outline-none border-b border-transparent hover:border-gray-300 focus:border-gray-400 w-1/2" value={header.customerDepartment || ''} onChange={e => updateHeader('customerDepartment', e.target.value)} placeholder="部署名" />
                        </div>
                      </div>
                    </div>
                    <div className="border-b border-black p-3 flex-1">
                      <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max mb-2">住所</div>
                      <div className="px-2">
                        <div className="flex items-center text-sm mb-1">〒<input className="ml-1 bg-transparent outline-none" value={header.customerZipCode || ''} onChange={e => updateHeader('customerZipCode', e.target.value)} placeholder="000-0000" /></div>
                        <textarea className="text-base mb-2 w-full bg-transparent outline-none resize-none overflow-hidden" rows="2" value={header.customerAddress || ''} onChange={e => updateHeader('customerAddress', e.target.value)} placeholder="住所" />
                        <div className="flex flex-wrap items-center gap-4 text-sm mt-3">
                           <div className="flex items-center"><span className="font-bold mr-2 text-gray-600 text-xs">TEL:</span><input className="bg-transparent outline-none" value={header.customerTel || ''} onChange={e => updateHeader('customerTel', e.target.value)} /></div>
                           <div className="flex items-center"><span className="font-bold mr-2 text-gray-600 text-xs">FAX:</span><input className="bg-transparent outline-none" value={header.customerFax || ''} onChange={e => updateHeader('customerFax', e.target.value)} /></div>
                        </div>
                      </div>
                    </div>
                    <div className="p-3 flex justify-between items-center bg-gray-50 h-16">
                       <div className="flex items-center gap-2 w-1/2"><span className="text-xs bg-label px-2 py-1 rounded font-bold border border-gray-300 whitespace-nowrap">先方担当</span><input className="font-bold border-b border-gray-300 px-2 w-full text-base bg-transparent outline-none" value={header.salesRepClient || ''} onChange={e => updateHeader('salesRepClient', e.target.value)} /></div>
                       <div className="flex items-center gap-2 w-1/2 ml-2"><span className="text-xs bg-label px-2 py-1 rounded font-bold border border-gray-300 whitespace-nowrap">営業担当</span><input className="font-bold border-b border-gray-300 px-2 w-full text-base bg-transparent outline-none" value={header.salesRepInternalMain || ''} onChange={e => updateHeader('salesRepInternalMain', e.target.value)} /></div>
                    </div>
                  </div>
                  <div className="col-span-6 flex flex-col">
                    <div className="border-b border-black flex-1 p-3">
                       <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max mb-2">直送先</div>
                       <div className="px-2 text-sm space-y-1">
                          <input className="font-bold text-base border-b border-dashed border-gray-300 pb-1 mb-1 w-full bg-transparent outline-none" value={header.shipName || ''} onChange={e => updateHeader('shipName', e.target.value)} placeholder="(直送先名)" />
                          <textarea className="w-full bg-transparent outline-none resize-none" rows="2" value={header.shipAddress || ''} onChange={e => updateHeader('shipAddress', e.target.value)} placeholder="住所" />
                          <div className="text-gray-600 mt-1 flex items-center">TEL: <input className="ml-2 bg-transparent outline-none" value={header.shipTel || ''} onChange={e => updateHeader('shipTel', e.target.value)} /></div>
                       </div>
                    </div>
                    <div className="grid grid-cols-12 border-t border-black">
                      {(mode === 'rental' || mode === 'communication') && (
                        <>
                          <div className="col-span-12 border-b border-black p-1 flex items-center bg-yellow-50">
                            <div className="text-xs bg-label w-16 py-1 rounded font-bold border border-gray-300 text-center mr-2">期間</div>
                            <div className="flex-1 text-sm flex justify-between items-center font-mono relative">
                               <input type="text" value={header.periodStartDate || ''} onChange={e => updateHeader('periodStartDate', e.target.value)} className="bg-transparent border-b border-gray-300 w-28 text-center outline-none" placeholder="yyyy/mm/dd" />
                               <span className="mx-2">～</span>
                               <input type="text" value={header.periodEndDate || ''} onChange={e => updateHeader('periodEndDate', e.target.value)} className="bg-transparent border-b border-gray-300 w-28 text-center outline-none" placeholder="yyyy/mm/dd" />
                               <label className="ml-4 flex items-center cursor-pointer text-xs font-bold text-gray-700 select-none"><input type="checkbox" className="mr-1" checked={isIndefinite} onChange={e => setIsIndefinite(e.target.checked)} />終了まで</label>
                               {!isIndefinite && <span className="ml-4 font-bold whitespace-nowrap">全 {periodMonths} ヶ月</span>}
                               <button onClick={handleAutoGenerateSchedule} className="ml-auto bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700 flex items-center print-hidden shadow-sm"><Calculator className="w-3 h-3 mr-1" /> スケジュール生成</button>
                            </div>
                          </div>
                        </>
                      )}
                      <div className="col-span-12 p-3 pb-2 border-b border-black">
                        <div className="text-xs bg-label px-3 py-0.5 rounded font-bold border border-gray-300 w-max mb-2">集金条件</div>
                        <div className="grid grid-cols-2 gap-4 px-2 mb-2">
                           <div className="flex items-center">
                             <span className="font-bold text-sm mr-2 w-16 text-right">締め日:</span>
                             <select value={header.closingDate || ''} onChange={e => updateHeader('closingDate', e.target.value)} className="border-b border-gray-400 flex-1 text-center bg-transparent font-bold outline-none"><option value=""></option>{[...Array(12)].map((_, i) => (<option key={i + 1} value={i + 1}>{i + 1}</option>))}</select>
                           </div>
                           <div className="flex items-center">
                             <span className="font-bold text-sm mr-2 w-16 text-right">支払日:</span>
                             <input value={header.paymentDate || ''} onChange={e => updateHeader('paymentDate', e.target.value)} className="border-b border-gray-400 flex-1 text-center bg-transparent outline-none" list="payment-dates" placeholder="(選択/入力)" />
                           </div>
                        </div>
                        <div className="flex mt-2 px-2 items-start">
                          <span className="font-bold text-sm mr-2 mt-1 whitespace-nowrap">支払条件:</span>
                          <div className="flex-1 border border-black rounded bg-white">
                            <div className="border-b border-gray-300">
                               <select className="w-full bg-transparent px-2 py-1 text-sm font-bold outline-none" value={paymentConditionType} onChange={e => updatePaymentType(e.target.value)}><option value="従来通り">従来通り</option><option value="従来通り以外">従来通り以外</option></select>
                            </div>
                            <div><input type="text" list="payment-details" className="w-full bg-transparent px-2 py-1 text-sm outline-none placeholder-gray-400" placeholder="(詳細を入力)" value={paymentConditionDetail} onChange={e => updatePaymentDetail(e.target.value)}/></div>
                          </div>
                        </div>
                      </div>
                      
                      {/* ★修正: 出荷・納期エリア (グリッドレイアウト) */}
                      <div className="col-span-12 p-2 border-b border-black bg-white">
                        <div className="grid grid-cols-[20px_1fr_1fr_1fr] gap-x-2 text-center text-xs font-bold text-gray-600 mb-1">
                           <div></div>
                           <div className="bg-gray-100 rounded py-0.5">出荷日</div>
                           <div className="bg-gray-100 rounded py-0.5">納期</div>
                           <div className="bg-gray-100 rounded py-0.5">時間帯</div>
                        </div>
                        {[1, 2, 3].map(num => (
                          <div key={num} className="grid grid-cols-[20px_1fr_1fr_1fr] gap-x-2 items-center mb-1 last:mb-0">
                             <div className="text-center font-bold text-sm">{num === 1 ? '①' : num === 2 ? '②' : '③'}</div>
                             <div><input className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`shipDate${num}`] || ''} onChange={e => updateHeader(`shipDate${num}`, e.target.value)} placeholder="yyyy/mm/dd" /></div>
                             <div><input className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`deliveryDate${num}`] || ''} onChange={e => updateHeader(`deliveryDate${num}`, e.target.value)} placeholder="yyyy/mm/dd" /></div>
                             <div>
                               <select className="w-full text-center bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm" value={header[`deliveryTime${num}`] || ''} onChange={e => updateHeader(`deliveryTime${num}`, e.target.value)}>
                                  <option value="">指定なし</option><option value="午前中">午前中</option><option value="14時～16時">14時～16時</option><option value="16時～18時">16時～18時</option><option value="18時以降">18時以降</option>
                               </select>
                             </div>
                          </div>
                        ))}
                      </div>
                    </div>
                    {mode === 'rental' && header.shippingInfo && (
                      <div className="border-t border-black p-2 text-xs bg-blue-50">
                          <div className="font-bold text-blue-800 mb-1">[出荷指示]</div>
                          <div className="flex flex-wrap gap-x-3 gap-y-1 px-1"><span><span className="font-bold">{safeText(header.shippingInfo.date)}</span> 出荷</span><span>({safeText(header.shippingInfo.carrier)})</span><span>着:{safeText(header.shippingInfo.deliveryDate)} {safeText(header.shippingInfo.time)}</span><span>伝:{safeText(header.shippingInfo.slipNo)}</span><span className="text-red-600 font-bold border border-red-600 px-1 ml-auto bg-white">{safeText(header.shippingInfo.status)}</span></div>
                      </div>
                    )}
                    {mode !== 'rental' && (
                      <div className="h-20 flex">
                         <div className="text-xs bg-label px-2 py-4 rounded font-bold border border-gray-300 writing-vertical-lr text-center mr-2 h-full flex items-center justify-center m-1">技術課<br/>依頼書</div>
                         <div className="flex-1 p-2 flex items-center"><input type="text" list="tech-requests" value={header.internalMemo || ''} onChange={e => updateHeader('internalMemo', e.target.value)} className="w-full text-sm bg-transparent border-b border-gray-300 p-1 focus:border-blue-500 outline-none transition-colors" placeholder="(選択または入力)"/></div>
                      </div>
                    )}
                  </div>
                </div>

                <div className="border-2 border-black mb-6">
                  {/* ... (Items Grid) ... */}
                  <div className={`grid ${gridColsClass} bg-label border-b border-black text-center font-bold py-2 text-sm`}>
                    <div className="text-[10px] text-gray-500">操作</div>
                    <div className="border-l border-black border-r">品 名</div>
                    {mode !== 'sales' && <div className="border-r border-black">規格</div>}
                    <div className="border-r border-black">数量</div><div className="border-r border-black">単位</div><div className="border-r border-black">単価</div><div className="border-r border-black">金額</div>
                    <div className="border-r border-black">原価金額</div>
                    {mode !== 'sales' && <div className="border-r border-black">備考</div>}
                  </div>
                  {items.map((row, i) => (
                    <div key={row.id} className={`relative grid ${gridColsClass} border-b border-black last:border-none text-sm min-h-[32px] group`}>
                      <div className="flex items-center justify-center relative"><div className="opacity-0 group-hover:opacity-100 flex items-center space-x-1 print-hidden"><button onClick={() => deleteItem(i)} className="text-gray-300 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div></div>
                      
                      <div className="border-l border-black border-r p-1 pl-3"><input className="w-full bg-transparent outline-none font-medium" value={row.productName || ''} onChange={e => updateItem(i, 'productName', e.target.value)} /></div>
                      {mode !== 'sales' && <div className="border-r border-black p-1"><input className="w-full bg-transparent outline-none text-center" value={row.spec || ''} onChange={e => updateItem(i, 'spec', e.target.value)} /></div>}
                      <div className="border-r border-black p-1"><input type="number" className="w-full text-right bg-transparent outline-none font-mono" value={row.quantity || ''} onChange={e => updateItem(i, 'quantity', e.target.value)} /></div>
                      <div className="border-r border-black p-1"><input className="w-full text-center bg-transparent outline-none" value={row.unit || ''} onChange={e => updateItem(i, 'unit', e.target.value)} /></div>
                      <div className="border-r border-black p-1"><input type="number" className="w-full text-right bg-transparent outline-none font-mono" value={row.unitPrice || ''} onChange={e => updateItem(i, 'unitPrice', e.target.value)} /></div>
                      <div className={`border-r border-black p-1 px-2 text-right font-mono font-bold`}>{row.amount ? Number(row.amount).toLocaleString() : ''}</div>
                      
                      <div className="border-r border-black p-1"><input type="number" className="w-full text-right bg-transparent outline-none font-mono text-xs" value={row.costAmount || ''} onChange={e => updateItem(i, 'costAmount', e.target.value)} placeholder="-" /></div>

                      {mode !== 'sales' && <div className="p-1 border-r border-black"><input className="w-full bg-transparent outline-none" value={row.note || ''} onChange={e => updateItem(i, 'note', e.target.value)} /></div>}
                    </div>
                  ))}
                  {[...Array(Math.max(0, 5 - items.length))].map((_, i) => (
                      <div key={`empty-${i}`} className={`grid ${gridColsClass} border-b border-black last:border-none text-sm min-h-[32px]`}>
                        <div></div>
                        <div className="border-l border-black border-r"></div>
                        {mode !== 'sales' && <div className="border-r border-black"></div>}
                        <div className="border-r border-black"></div><div className="border-r border-black"></div><div className="border-r border-black"></div><div className="border-r border-black"></div>
                        <div className="border-r border-black"></div>
                        {mode !== 'sales' && <div className="border-r border-black"></div>}
                        <div></div>
                      </div>
                  ))}
                  
                  <div className="border-t border-black border-b border-black text-sm">
                    {mode === 'sales' ? (
                      <div className="bg-gray-50 p-2 flex justify-end items-center space-x-6 pr-4">
                        <div className="flex items-center"><span className="text-xs font-bold mr-2">小計</span><span className="font-mono text-base">{totals.subtotal.toLocaleString()}</span></div>
                        <div className="flex items-center"><span className="text-xs font-bold mr-2">消費税</span><span className="font-mono text-base">{totals.tax.toLocaleString()}</span></div>
                        <div className="flex items-center"><span className="text-sm font-bold mr-2">合計</span><span className="font-mono text-xl font-bold">{totals.total.toLocaleString()} 円</span></div>
                      </div>
                    ) : (
                      <div className="bg-yellow-50">
                          <div className="p-2 flex justify-end items-center space-x-6 pr-4 border-b border-gray-300">
                              <span className="font-bold text-gray-700 mr-auto pl-2">【初回ご請求】</span>
                              <div className="flex items-center"><span className="text-xs text-gray-500 mr-2">小計</span><span className="font-mono">{totals.subtotal.toLocaleString()}</span></div>
                              <div className="flex items-center"><span className="text-xs text-gray-500 mr-2">消費税</span><span className="font-mono">{totals.tax.toLocaleString()}</span></div>
                              <div className="flex items-center"><span className="text-xs font-bold mr-2">合計</span><span className="font-mono text-lg font-bold">{totals.total.toLocaleString()} 円</span></div>
                          </div>
                          <div className="p-2 flex justify-end items-center space-x-6 pr-4">
                              <span className="font-bold text-gray-700 mr-auto pl-2">【2回目以降 (月額)】</span>
                              <div className="flex items-center"><span className="text-xs text-gray-500 mr-2">小計</span><span className="font-mono">{itemsTotal.toLocaleString()}</span></div>
                              <div className="flex items-center"><span className="text-xs text-gray-500 mr-2">消費税</span><span className="font-mono">{monthlyTax.toLocaleString()}</span></div>
                              <div className="flex items-center"><span className="text-xs font-bold mr-2">合計</span><span className="font-mono text-lg font-bold">{monthlyTotal.toLocaleString()} 円</span></div>
                          </div>
                      </div>
                    )}
                  </div>

                  <div className="p-1 border-t-0 bg-white print-hidden text-center mt-1">
                      <button onClick={() => { const newItems = [...items, { id: generateId(), productName: '', quantity: '', unit: '', unitPrice: '', amount: 0 }]; onChange({...data, items: newItems}); }} className="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center justify-center w-full"><Plus className="w-3 h-3 mr-1" /> 明細を追加</button>
                  </div>
                </div>

                {mode !== 'sales' && (
                  <div className="border-2 border-black mb-6 relative">
                    <div className={`grid ${gridColsSchedule} bg-label border-b border-black text-center font-bold py-2 text-sm`}>
                      <div className="text-[10px] text-gray-500">操作</div>
                      <div className="border-l border-black border-r">回数</div><div className="border-r border-black">売上日</div><div className="border-r border-black">{mode === 'sales' ? '請求金額' : '原価'}</div><div className="border-r border-black">伝票No</div><div className="border-r border-black">締め日</div><div className="border-r border-black">備考</div><div>チェック</div>
                    </div>
                    {schedule.map((row, i) => {
                      if (row.count === '延長') {
                        return (
                          <div key={row.id} className="grid grid-cols-[30px_3rem_1fr] border-b border-black last:border-none text-sm min-h-[32px] group bg-pink-100">
                             <div className="flex items-center justify-center relative"><div className="opacity-0 group-hover:opacity-100 flex items-center space-x-1 print-hidden"><button onClick={() => removeScheduleRow(i)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div></div>
                             <div className="border-l border-black border-r border-black p-1 text-center font-bold text-red-600 bg-pink-100">延長</div>
                             <div className="p-1">
                               <input className="w-full bg-transparent outline-none font-bold text-red-800" value={row.billingDate || ''} onChange={e => updateSchedule(i, 'billingDate', e.target.value)} placeholder="(延長の詳細を入力: 例: 2025/10/01〜2026/03/31 6ヶ月)" />
                             </div>
                          </div>
                        );
                      }
                      
                      return (
                        <div key={row.id} className={`grid ${gridColsSchedule} border-b border-black last:border-none text-sm min-h-[32px] group`}>
                          <div className="flex items-center justify-center relative"><div className="opacity-0 group-hover:opacity-100 flex items-center space-x-1 print-hidden"><button onClick={() => removeScheduleRow(i)} className="text-gray-300 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div></div>
                          
                          <div className="border-l border-black border-r p-1 text-center font-bold"><input className="w-full bg-transparent outline-none text-center" value={row.count || ''} onChange={e => updateSchedule(i, 'count', e.target.value)} placeholder={`${i+1}回目`} /></div>
                          
                          <div className="border-r border-black p-1 text-center">
                             <input className={`w-full bg-transparent outline-none text-center font-mono ${mode==='communication'?'text-gray-400':''}`} value={row.billingDate || ''} onChange={e => updateSchedule(i, 'billingDate', e.target.value)} readOnly={mode==='communication'} />
                          </div>
                          
                          <div className="border-r border-black p-1 text-right"><input className="w-full bg-transparent outline-none text-right font-mono" value={mode === 'sales' ? (row.amount || '') : (row.costReference || '')} onChange={e => updateSchedule(i, mode === 'sales' ? 'amount' : 'costReference', e.target.value)} /></div>
                          
                          <div className="border-r border-black p-1 text-center">
                             <input className={`w-full bg-transparent outline-none text-center font-mono ${mode==='communication'?'text-gray-400':''}`} value={row.slipNo || ''} onChange={e => updateSchedule(i, 'slipNo', e.target.value)} readOnly={mode==='communication'} />
                          </div>
                          <div className="border-r border-black p-1 text-center">
                             <input className={`w-full bg-transparent outline-none text-center font-mono text-xs ${mode==='communication'?'text-gray-400':''}`} value={row.closingDate || ''} onChange={e => updateSchedule(i, 'closingDate', e.target.value)} readOnly={mode==='communication'} />
                          </div>
                          
                          <div className="border-r border-black p-1 flex items-center"><input className="w-full bg-transparent outline-none text-xs" value={row.note || ''} onChange={e => updateSchedule(i, 'note', e.target.value)} /></div>
                          <div className="p-1 text-center"><input className="w-full bg-transparent outline-none text-center text-xs" value={row.checkStatus || ''} onChange={e => updateSchedule(i, 'checkStatus', e.target.value)} /></div>
                        </div>
                      );
                    })}
                    
                    <div className="p-2 border-t border-gray-300 bg-gray-50 print-hidden text-center flex justify-center space-x-4">
                      <button onClick={addScheduleRow} className="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center justify-center bg-white px-4 py-1 rounded border border-blue-200 shadow-sm hover:bg-blue-50"><Plus className="w-3 h-3 mr-1" /> 行を追加する</button>
                      <button onClick={addExtensionRow} className="text-pink-600 hover:text-pink-800 text-xs font-bold flex items-center justify-center bg-white px-4 py-1 rounded border border-pink-200 shadow-sm hover:bg-pink-50"><Clock className="w-3 h-3 mr-1" /> 延長</button>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-12 gap-6 mt-6">
                  <div className="col-span-12 border border-black p-3">
                    <div className="text-xs font-bold border-b border-black mb-2 flex justify-between items-center">
                      <span>備考 / 履歴</span><button onClick={addRemark} className="text-blue-600 hover:text-blue-800 flex items-center text-xs"><Plus className="w-3 h-3 mr-1" /> 追加</button>
                    </div>
                    <div className="w-full text-sm">
                      <div className="grid grid-cols-[80px_100px_1fr_100px_140px_30px] gap-2 border-b border-gray-300 pb-1 mb-1 font-bold text-xs bg-gray-100 p-1"><div>カテゴリ</div><div>日時</div><div>内容</div><div>状況</div><div>メール送付</div><div></div></div>
                      <div className="overflow-y-auto max-h-48">
                        {remarks.map((rmk, idx) => (
                          <div key={rmk.id} className="grid grid-cols-[80px_100px_1fr_100px_140px_30px] gap-2 mb-1 items-center hover:bg-gray-50 p-1">
                            <div><select className="w-full border border-gray-300 text-xs p-1 bg-white" value={rmk.category || 'その他'} onChange={e => updateRemark(idx, 'category', e.target.value)}><option value="請求">請求</option><option value="出荷">出荷</option><option value="その他">その他</option></select></div>
                            <div><input className="w-full border-b border-gray-300 outline-none text-xs" value={rmk.date || ''} onChange={e => updateRemark(idx, 'date', e.target.value)} placeholder="日付" /></div>
                            <div><input className="w-full border-b border-gray-300 outline-none text-sm" value={rmk.content || ''} onChange={e => updateRemark(idx, 'content', e.target.value)} /></div>
                            <div><input className="w-full border-b border-gray-300 outline-none text-xs" value={rmk.status || ''} onChange={e => updateRemark(idx, 'status', e.target.value)} /></div>
                            <div className="flex items-center"><input className="flex-1 border-b border-gray-300 outline-none text-xs mr-1" value={rmk.mailSent || ''} onChange={e => updateRemark(idx, 'mailSent', e.target.value)} placeholder="-" /><button onClick={() => markMailSent(idx)} className="text-blue-500 hover:text-blue-700"><Mail className="w-4 h-4" /></button></div>
                            <div className="text-center"><button onClick={() => deleteRemark(idx)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          </div>
        );
      };

      // --- 親コンポーネント (タブ管理) ---
      function App() {
        const [tabs, setTabs] = useState([]);
        const [activeTabId, setActiveTabId] = useState(null);
        const [saveStatus, setSaveStatus] = useState('idle');
        const [loading, setLoading] = useState(true);
        const [errorMsg, setErrorMsg] = useState('');
        const [loadedServerItems, setLoadedServerItems] = useState([]);
        const [loadedServerSchedule, setLoadedServerSchedule] = useState([]);

        useEffect(() => {
          loadData(INITIAL_ORDER_NO, INITIAL_SUMMARY_CODE);
        }, []);

        const loadData = (orderNo, summaryCode) => {
          if (typeof google !== 'undefined' && google.script) {
            google.script.run
              .withSuccessHandler((data) => {
                document.getElementById('loading').style.display = 'none';
                if (data.success === false) {
                   setErrorMsg(data.header ? (data.header.title + "\n" + (data.logs||[]).join("\n")) : "ロードエラー");
                   setLoading(false);
                   return;
                }
                const processedData = processLoadedData(data);
                setLoadedServerItems(processedData.items || []);
                setLoadedServerSchedule(processedData.schedule || []);

                const firstTabId = generateId();
                const modeTitle = data.mode === 'sales' ? '販売' : (data.mode === 'rental' ? 'レンタル' : '通信');
                const filteredItems = (processedData.items || []).filter(i => !i.modeType || i.modeType === data.mode);
                const filteredSchedule = (processedData.schedule || []).filter(s => !s.modeType || s.modeType === data.mode);
                const sub = filteredItems.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                          + filteredSchedule.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
                const tax = Math.floor(sub * 0.1);

                const initialTabData = {
                   ...processedData,
                   items: filteredItems,
                   schedule: filteredSchedule,
                   totals: { subtotal: sub, tax, total: sub+tax }
                };
                
                setTabs([{
                  id: firstTabId,
                  title: modeTitle,
                  mode: data.mode,
                  data: initialTabData
                }]);
                setActiveTabId(firstTabId);
                setLoading(false);
              })
              .withFailureHandler((error) => {
                document.getElementById('loading').style.display = 'none';
                setErrorMsg("システムエラー: " + error.message);
              })
              .getOrderData(orderNo, summaryCode);
          } else {
            // Mock
            document.getElementById('loading').style.display = 'none';
            const mockData = {
               mode: 'sales',
               header: { formId: "TEST", title: "テスト", orderNo: "TEST-001", customerName: "テスト株式会社" },
               items: [{id:1, productName:"テスト商品A", quantity:1, unit:"個", unitPrice:1000, amount:1000}],
               schedule: [], remarks: [], totals: {subtotal:1000, tax:100, total:1100}
            };
            const processed = processLoadedData(mockData);
            const tid = generateId();
            setLoadedServerItems(processed.items);
            setLoadedServerSchedule(processed.schedule);
            setTabs([{ id: tid, title: '販売', mode: 'sales', data: processed }]);
            setActiveTabId(tid);
            setLoading(false);
          }
        };

        const processLoadedData = (data) => {
          const cleanHeader = data.header || {};
          const validTechRequests = ["機械器具設置", "電気通信", "保守点検", "修繕", "その他"];
          if (cleanHeader.internalMemo && !validTechRequests.includes(cleanHeader.internalMemo)) {
             cleanHeader.internalMemo = "";
          }
          let pType = '従来通り';
          let pDetail = '';
          const rawMethod = cleanHeader.collectionMethod || "";
          if (rawMethod === "従来通り" || rawMethod === "" || rawMethod === "振込") {
             pType = "従来通り";
          } else if (rawMethod.includes("従来通り以外")) {
             pType = "従来通り以外";
             pDetail = rawMethod.replace("従来通り以外", "").trim();
          } else {
             pType = "従来通り以外";
             pDetail = rawMethod;
          }
          const validItems = (data.items || []).filter(item => {
            if (item.quantity === "" || item.quantity === null || item.quantity === undefined) return false;
            const qty = Number(item.quantity);
            return !isNaN(qty) && qty !== 0;
          });
          return {
             ...data,
             header: cleanHeader,
             items: validItems,
             schedule: data.schedule || [],
             paymentConditionType: pType,
             paymentConditionDetail: pDetail
          };
        };

        const handleTabChange = (tabId, newData) => {
          setTabs(prev => prev.map(t => t.id === tabId ? { ...t, data: newData } : t));
        };

        const addNewTab = (mode) => {
          const currentTab = tabs.find(t => t.id === activeTabId);
          const baseData = currentTab ? currentTab.data : null;
          const copiedItems = loadedServerItems.map(item => ({
             ...item,
             id: generateId(), 
             modeType: mode 
          }));
          let initialSchedule = loadedServerSchedule.filter(s => s.modeType === mode);
          if (initialSchedule.length === 0 && mode !== 'sales') {
             initialSchedule = Array(3).fill(null).map((_, i) => ({
                id: generateId(), count: (i + 1) + '回目', billingDate: '', amount: '', costReference: '', slipNo: '', closingDate: '', note: '', checkStatus: '', modeType: mode
             }));
          }
          const sub = copiedItems.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                    + initialSchedule.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
          const tax = Math.floor(sub * 0.1);
          const newId = generateId();
          const title = mode === 'sales' ? '販売' : (mode === 'rental' ? 'レンタル' : '通信');
          const newData = {
             mode: mode,
             header: { 
               ...(baseData?.header || {}), 
               orderNo: baseData?.header?.orderNo || "",
               periodStartDate: "", periodEndDate: "" 
             },
             items: copiedItems, 
             schedule: initialSchedule,
             remarks: [],
             totals: { subtotal: sub, tax, total: sub+tax },
             paymentConditionType: baseData?.paymentConditionType || '従来通り',
             paymentConditionDetail: baseData?.paymentConditionDetail || ''
          };
          setTabs([...tabs, { id: newId, title, mode, data: newData }]);
          setActiveTabId(newId);
        };

        const removeTab = (e, tabId) => {
          e.stopPropagation();
          if (tabs.length <= 1) {
            alert("最後のタブは削除できません。");
            return;
          }
          if (!confirm("このシート（タブ）を削除しますか？\n入力内容は失われます。")) return;
          const newTabs = tabs.filter(t => t.id !== tabId);
          setTabs(newTabs);
          if (activeTabId === tabId) setActiveTabId(newTabs[0].id);
        };

        const handleSave = (tabId) => {
          const targetTab = tabs.find(t => t.id === tabId);
          if (!targetTab) return;
          if(!confirm(`「${targetTab.title}」タブの内容を保存しますか？`)) return;
          document.getElementById('loading').style.display = 'flex';
          setSaveStatus('saving');
          const d = targetTab.data;
          let combinedMethod = d.paymentConditionType === "従来通り" ? "従来通り" : "従来通り以外" + (d.paymentConditionDetail ? (" " + d.paymentConditionDetail) : "");
          const updatedHeader = { ...d.header, collectionMethod: combinedMethod };
          const saveData = {
            orderNo: d.header.orderNo,
            mode: d.mode, 
            header: updatedHeader,
            items: d.items, schedule: d.schedule, remarks: d.remarks, totals: d.totals,
            updatedAt: new Date().toISOString()
          };
          if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler((res) => {
                document.getElementById('loading').style.display = 'none';
                setSaveStatus('saved');
                alert(res.message);
                setTimeout(() => setSaveStatus('idle'), 3000);
              }).withFailureHandler((err) => {
                document.getElementById('loading').style.display = 'none';
                setSaveStatus('error');
                alert("保存エラー: " + err);
              }).saveOrderData(saveData);
          } else {
             setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                setSaveStatus('saved');
                alert("保存しました(Mock)");
             }, 1000);
          }
        };

        const handleExportExcel = (tabId) => {
           const targetTab = tabs.find(t => t.id === tabId);
           if (!targetTab) return;
           if (!confirm(`「${targetTab.title}」タブのExcelを生成しますか？`)) return;
           document.getElementById('loading').style.display = 'flex';
           const d = targetTab.data;
           let combinedMethod = d.paymentConditionType === "従来通り" ? "従来通り" : "従来通り以外" + (d.paymentConditionDetail ? (" " + d.paymentConditionDetail) : "");
           const updatedHeader = { ...d.header, collectionMethod: combinedMethod };
           const saveData = { orderNo: d.header.orderNo, mode: d.mode, header: updatedHeader, items: d.items, schedule: d.schedule, remarks: d.remarks, totals: d.totals };
           if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler((res) => {
                document.getElementById('loading').style.display = 'none';
                if (res.success) { window.open(res.url, '_blank'); alert(res.message); } else { alert(res.message); }
              }).withFailureHandler((err) => {
                document.getElementById('loading').style.display = 'none'; alert("Excel生成エラー: " + err);
              }).generateOrderSheet(saveData);
           }
        };
        
        const [addMenuOpen, setAddMenuOpen] = useState(false);

        if (errorMsg) return <div className="p-10 text-center bg-red-50 min-h-screen text-red-600 font-bold"><pre>{errorMsg}</pre></div>;
        if (loading) return null;

        return (
          <div className="min-h-screen bg-gray-200 p-6 font-sans text-base print-full print:p-0 print:bg-white text-gray-900 flex flex-col items-center pb-40">
            <div id="tab-bar" className="w-full max-w-[1100px] flex items-end space-x-1 mb-0 print-hidden">
               {tabs.map(tab => (
                 <div key={tab.id} onClick={() => setActiveTabId(tab.id)} className={`px-4 py-2 rounded-t-lg font-bold text-sm cursor-pointer flex items-center border-t border-x relative group transition-colors ${activeTabId === tab.id ? 'tab-active shadow-sm -mb-px z-10' : 'tab-inactive hover:bg-gray-300'}`} style={{ height: '42px' }}>
                    <span className="mr-2">{tab.title}</span>
                    <button onClick={(e) => removeTab(e, tab.id)} className="text-gray-400 hover:text-red-500 rounded-full p-0.5"><X className="w-3 h-3" /></button>
                 </div>
               ))}
               <div className="relative">
                 <button onClick={() => setAddMenuOpen(!addMenuOpen)} className="px-3 py-2 bg-gray-600 text-white rounded-t-lg hover:bg-gray-700 transition-colors flex items-center h-[42px] font-bold text-xs"><Plus className="w-4 h-4 mr-1" /> 追加</button>
                 {addMenuOpen && (
                   <div className="absolute top-10 left-0 bg-white shadow-xl rounded border border-gray-300 w-32 z-50 overflow-hidden">
                      <button onClick={() => { addNewTab('sales'); setAddMenuOpen(false); }} className="block w-full text-left px-4 py-2 hover:bg-blue-50 text-sm">販売</button>
                      <button onClick={() => { addNewTab('rental'); setAddMenuOpen(false); }} className="block w-full text-left px-4 py-2 hover:bg-green-50 text-sm">レンタル</button>
                      <button onClick={() => { addNewTab('communication'); setAddMenuOpen(false); }} className="block w-full text-left px-4 py-2 hover:bg-purple-50 text-sm">通信費</button>
                   </div>
                 )}
               </div>
            </div>
            {tabs.map(tab => (
              <SingleOrderSheet key={tab.id} tabId={tab.id} data={tab.data} isActive={activeTabId === tab.id} onChange={(newData) => handleTabChange(tab.id, newData)} onSave={handleSave} onExportExcel={handleExportExcel} allTabs={tabs} saveStatus={saveStatus} />
            ))}
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
